<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SanketSathi AI Sentinel | Active Monitoring</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #050a14;
            --card-bg: #0f172a;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --accent-cyan: #06b6d4;
            --accent-alert: #ef4444;
            --grid-line: #1e293b;
        }

        body { 
            background-color: var(--bg-color); 
            color: var(--text-primary); 
            font-family: 'JetBrains Mono', monospace;
            background-image: 
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        .hero-section {
            border-bottom: 2px solid var(--accent-cyan);
            background: rgba(15, 23, 42, 0.95);
            padding: 30px 0;
            position: relative;
            overflow: hidden;
        }
        
        .hero-section::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-cyan), transparent);
            animation: scanline 2s linear infinite;
        }

        @keyframes scanline {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        h1 { font-family: 'Orbitron', sans-serif; letter-spacing: 2px; color: var(--accent-cyan); text-shadow: 0 0 10px rgba(6, 182, 212, 0.5); }
        
        .input-group-agent {
            border: 1px solid var(--accent-cyan);
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.2);
        }
        .form-control-agent {
            background: #000;
            border: none;
            color: var(--accent-cyan);
            font-family: 'JetBrains Mono';
        }
        .form-control-agent:focus {
            background: #000;
            color: #fff;
            box-shadow: none;
        }
        .btn-agent {
            background: var(--accent-cyan);
            color: #000;
            font-weight: bold;
            border: none;
        }
        .btn-agent:hover { background: #fff; color: var(--accent-cyan); }

        .news-card { 
            background: var(--card-bg);
            border: 1px solid var(--grid-line);
            border-left: 3px solid var(--accent-cyan);
            transition: all 0.3s;
        }
        .news-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.15); 
            border-left-color: #fff;
        }
        
        .card-img-top { 
            height: 180px; 
            object-fit: cover; 
            filter: grayscale(40%) contrast(1.2);
            transition: filter 0.3s;
        }
        .news-card:hover .card-img-top { filter: grayscale(0%); }

        .badge-category { 
            position: absolute; top: 10px; right: 10px; 
            font-family: 'Orbitron'; font-size: 0.7rem; letter-spacing: 1px;
            padding: 5px 10px;
            background: rgba(0,0,0,0.8);
            border: 1px solid currentColor;
        }
        
        .badge-Flood { color: #3b82f6; border-color: #3b82f6; }
        .badge-Earthquake { color: #a855f7; border-color: #a855f7; }
        .badge-Wildfire { color: #f97316; border-color: #f97316; }
        .badge-Cyclone { color: #06b6d4; border-color: #06b6d4; }
        .badge-General { color: #94a3b8; border-color: #94a3b8; }

        .terminal-log {
            font-size: 0.8rem;
            color: var(--accent-cyan);
            height: 120px;
            padding: 10px;
            border: 1px dashed var(--grid-line);
            background: rgba(0,0,0,0.5);
            overflow-y: auto;
            margin-bottom: 20px;
        }
        .log-entry { margin-bottom: 2px; }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }

        .status-dot { height: 10px; width: 10px; background-color: #22c55e; border-radius: 50%; display: inline-block; margin-right: 5px; box-shadow: 0 0 10px #22c55e; }
        .status-text { font-size: 0.8rem; color: #22c55e; letter-spacing: 1px; }

        .card-text-clamp {
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

    </style>
</head>
<body>

<div class="hero-section text-center">
    <div class="container">
        <h1><i class="bi bi-robot"></i> SANKET.SATHI_AI</h1>
        <p class="text-secondary small">AUTONOMOUS DISASTER SURVEILLANCE SYSTEM</p>
        <div class="mt-2">
            <span class="status-dot"></span><span class="status-text">SYSTEM ONLINE // MONITORING GLOBAL FEEDS</span>
        </div>
    </div>
</div>

<div class="container mt-5">
    
    <div class="row">
        <!-- Agent Interface -->
        <div class="col-lg-4 mb-4">
            <div class="p-3 border border-secondary rounded bg-dark">
                <label class="form-label text-info small mb-2">> DEFINE PROXIMITY PARAMETERS</label>
                <div class="input-group input-group-agent mb-3">
                    <button class="btn btn-outline-info border-end-0" type="button" onclick="initSequence()" title="Re-acquire GPS Coordinates">
                         <span style="font-size: 1.2rem;">‚åñ</span>
                    </button>
                    <input type="text" id="locationInp" class="form-control form-control-agent border-start-0" placeholder="ENTER CITY/REGION (e.g., California)" value="India">
                    <button onclick="deployAgent()" class="btn btn-agent">SCAN</button>
                </div>
                
                <label class="form-label text-secondary small mb-1">> AGENT LOGS_</label>
                <div class="terminal-log" id="terminalLogs">
                    <div class="log-entry">> Initializing AI protocols...</div>
                    <div class="log-entry">> Neural net active.</div>
                    <div class="log-entry">> Waiting for target coordinates...<span class="blink">_</span></div>
                </div>
            </div>
        </div>

        <!-- News Feed -->
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="text-light fs-5"><span class="text-danger">///</span> INTELLIGENCE FEED <span id="feed-location-badge" class="badge bg-secondary ms-2" style="font-size: 0.7rem; vertical-align: middle;">GLOBAL</span></h4>
                <span id="last-updated" class="text-secondary small" style="font-family: inherit;"></span>
            </div>

            <!-- News Grid -->
            <div id="news-container" class="row row-cols-1 row-cols-md-2 g-3">
                <!-- Content injected via JS -->
                 <div class="col w-100 text-center text-secondary py-5">
                    > NO DATA IN CURRENT BUFFER
                 </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_FETCH = '/api/fetch-news';
    const API_GET = '/api/news';
    
    // Store user's coordinates globally
    let userLatitude = null;
    let userLongitude = null;
    
    // Log helper
    function log(msg) {
        const term = document.getElementById('terminalLogs');
        const time = new Date().toLocaleTimeString('en-US', {hour12: false});
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `<span class="text-secondary">[${time}]</span> ${msg}`;
        term.appendChild(entry);
        term.scrollTop = term.scrollHeight; // Auto scroll
    }

    function formatDate(dateString) {
        if(!dateString) return '';
        const options = { year: '2-digit', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false };
        return new Date(dateString).toLocaleDateString('en-GB', options).replace(',', '');
    }

    function getBadgeClass(category) {
        if(category === 'Flood') return 'badge-Flood';
        if(category === 'Earthquake') return 'badge-Earthquake';
        if(category === 'Wildfire') return 'badge-Wildfire';
        if(category === 'Cyclone') return 'badge-Cyclone';
        return 'badge-General';
    }

    async function loadNews() {
        // Pass the current selected location AND coordinates to the GET request for sorting
        const currentLocation = document.getElementById('locationInp').value;
        let queryParams = currentLocation ? `?location=${encodeURIComponent(currentLocation)}` : '';
        
        // Add coordinates if available for distance-based sorting
        if (userLatitude !== null && userLongitude !== null) {
            queryParams += (queryParams ? '&' : '?') + `latitude=${userLatitude}&longitude=${userLongitude}`;
        }
        
        try {
            const response = await fetch(API_GET + queryParams);
            let data;
            try {
                data = await response.json();
            } catch (e) {
                throw new Error("Invalid JSON from server");
            }
            
            if (data.error) throw new Error(data.error);
            if (!Array.isArray(data)) throw new Error("Invalid data format received");

            const container = document.getElementById('news-container');
            container.innerHTML = ''; 

            if (data.length === 0) {
                container.innerHTML = '<div class="col w-100 text-center text-secondary py-5">>> SCAN COMPLETE. NO THREATS DETECTED IN MONITORING WINDOW.</div>';
                return;
            }

            // Flag to show separator
            let foundNonLocal = false;

            data.forEach((item, index) => {
                // Show distance badge if available
                const distanceBadge = item.distance_km && item.distance_km !== Infinity 
                    ? `<span class="badge bg-success" style="position: absolute; top: 10px; left: 10px; font-size: 0.65rem;">${item.distance_km} km</span>` 
                    : '';
                
                const card = `
                    <div class="col">
                        <div class="card news-card h-100">
                            <span class="badge ${getBadgeClass(item.category)} badge-category">${item.category.toUpperCase()}</span>
                            ${distanceBadge}
                            <img src="${item.image_url}" class="card-img-top" alt="News Image" onerror="this.src='https://via.placeholder.com/600x400/0f172a/06b6d4?text=IMG_N/A'">
                            <div class="card-body d-flex flex-column bg-transparent">
                                <h6 class="card-title"><a href="${item.article_url}" target="_blank" class="text-decoration-none text-light hover-cyan">${item.title}</a></h6>
                                <p class="card-text small text-secondary flex-grow-1 card-text-clamp" style="font-size: 0.8rem;">${item.description || 'Data packet received. Access full link for details.'}</p>
                                <div class="mt-2 d-flex justify-content-between align-items-center small border-top border-dark pt-2">
                                    <span class="text-info" style="font-size: 0.7rem;">SRC: ${item.source_name.toUpperCase()}</span>
                                    <span class="text-secondary" style="font-size: 0.7rem;">${formatDate(item.published_at)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
            
            document.getElementById('last-updated').textContent = 'UPDATED: ' + new Date().toLocaleTimeString();
            log("> Visual matrix updated.");

        } catch (error) {
            log("> ERROR: Visual link offline. " + error.message);
        }
    }

    async function deployAgent() {
        const locationInp = document.getElementById('locationInp');
        const location = locationInp.value || "India";
        const btn = document.querySelector('.btn-agent');
        const badge = document.getElementById('feed-location-badge');
        
        btn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> SCANNING`;
        btn.disabled = true;

        log(`> Initiating scan sequence for sector: "${location.toUpperCase()}"...`);
        badge.textContent = "SCANNING...";
        badge.className = "badge bg-warning ms-2 animate-pulse";
        
        try {
            // Trigger backend fetch with location payload
            const res = await fetch(API_FETCH, { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ location: location })
            });

            if(res.ok) {
                const result = await res.json();
                log(`> Scan complete. ${result.new_articles_count} new intel packets acquired.`);
                if(result.new_articles_count === 0) {
                     log("> No local anomalies data found. Broadening search radius...");
                }
            } else {
                log("> WARNING: Satellite link unstable (API Error).");
            }
            
            await loadNews(); 
            badge.textContent = `SECTOR: ${location.toUpperCase()}`;
            badge.className = "badge bg-info ms-2";

        } catch (error) {
            log(`> CRITICAL FAILURE: ${error.message}`);
             badge.textContent = "OFFLINE";
             badge.className = "badge bg-danger ms-2";
        } finally {
            btn.innerHTML = "SCAN";
            btn.disabled = false;
        }
    }

    // --- AGENTIC AUTO-LOCATION ---
    async function initSequence() {
        log("> SYSTEM BOOT SEQUENCE...");
        const locInput = document.getElementById('locationInp');
        
        // Check Browser Geolocation
        if ("geolocation" in navigator) {
            log("> Requesting operator coordinates (ALLOW PERMISSION)...");
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    
                    // Store coordinates globally for distance-based sorting
                    userLatitude = lat;
                    userLongitude = lon;
                    
                    log(`> Coordinates locked: [${lat.toFixed(4)}, ${lon.toFixed(4)}]`);
                    log("> Distance-based news prioritization: ENABLED");
                    log("> reverse-geocoding sector name...");

                    try {
                        // Free High-performance reverse geocoding (No Key needed)
                        const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
                        const data = await response.json();
                        
                        // Prioritize City -> Locality -> Country
                        const city = data.city || data.locality || data.principalSubdivision || "India";
                        
                        log(`> Sector identified: ${city.toUpperCase()}`);
                        locInput.value = city;
                        
                        // Auto-Deploy with detected city
                        deployAgent();

                    } catch (e) {
                         log("> Geocode uplink failed. Defaulting to sector: INDIA");
                         deployAgent();
                    }
                },
                (error) => {
                    log("> Geolocation denied/failed. Defaulting to sector: INDIA");
                    log("> Distance-based sorting: DISABLED");
                    deployAgent();
                }
            );
        } else {
            log("> GPS Module not detected. Defaulting to sector: INDIA");
            log("> Distance-based sorting: DISABLED");
            deployAgent();
        }
    }

    // Start
    initSequence();

</script>

</script>

</body>
</html>
